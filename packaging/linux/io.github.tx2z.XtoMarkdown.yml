app-id: io.github.tx2z.XtoMarkdown
runtime: org.kde.Platform
runtime-version: "6.8"
sdk: org.kde.Sdk
command: xtomarkdown

build-options:
  build-args:
    - --share=network

finish-args:
  # X11 + XShm access (for Qt)
  - --share=ipc
  - --socket=fallback-x11
  # Wayland access
  - --socket=wayland
  # OpenGL access (for Qt Quick)
  - --device=dri
  # File system access for converting documents
  - --filesystem=home
  # For file dialogs
  - --talk-name=org.freedesktop.FileManager1

modules:
  # Pandoc - standalone binary (pypandoc-binary may not work in sandbox)
  - name: pandoc
    buildsystem: simple
    build-commands:
      - install -Dm755 bin/pandoc /app/bin/pandoc
    sources:
      - type: archive
        url: https://github.com/jgm/pandoc/releases/download/3.6.4/pandoc-3.6.4-linux-amd64.tar.gz
        sha256: 5def6e1ff535e397becce292ee97767a947306150b9fb1488003b67ac3417c5e
        # Verify: curl -sL URL | sha256sum

  # Python dependencies via pip
  - name: python-deps
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation --prefix=/app hatchling
      - pip3 install --no-build-isolation --prefix=/app Pillow
      - pip3 install --no-build-isolation --prefix=/app PySide6==6.7.0
      - pip3 install --no-build-isolation --prefix=/app platformdirs
      - pip3 install --no-build-isolation --prefix=/app pypandoc
      - pip3 install --no-build-isolation --prefix=/app "markitdown[all]"
    sources: []

  # XtoMarkdown application
  - name: xtomarkdown
    buildsystem: simple
    build-commands:
      # Install the application
      - pip3 install --no-build-isolation --no-deps --prefix=/app .
      # Install desktop file
      - install -Dm644 packaging/linux/io.github.tx2z.XtoMarkdown.desktop /app/share/applications/io.github.tx2z.XtoMarkdown.desktop
      # Install metainfo
      - install -Dm644 packaging/linux/io.github.tx2z.XtoMarkdown.metainfo.xml /app/share/metainfo/io.github.tx2z.XtoMarkdown.metainfo.xml
      # Install icons at multiple sizes (resize from 2048x2048 source)
      - |
        python3 << 'EOF'
        from PIL import Image
        import os
        os.makedirs('icons_out', exist_ok=True)
        img = Image.open('src/xtomarkdown/gui/resources/icons/app-icon.png')
        for size in [512, 256, 128, 64, 48]:
            resized = img.resize((size, size), Image.LANCZOS)
            resized.save(f'icons_out/icon-{size}.png')
        EOF
      - install -Dm644 icons_out/icon-512.png /app/share/icons/hicolor/512x512/apps/io.github.tx2z.XtoMarkdown.png
      - install -Dm644 icons_out/icon-256.png /app/share/icons/hicolor/256x256/apps/io.github.tx2z.XtoMarkdown.png
      - install -Dm644 icons_out/icon-128.png /app/share/icons/hicolor/128x128/apps/io.github.tx2z.XtoMarkdown.png
      - install -Dm644 icons_out/icon-64.png /app/share/icons/hicolor/64x64/apps/io.github.tx2z.XtoMarkdown.png
      - install -Dm644 icons_out/icon-48.png /app/share/icons/hicolor/48x48/apps/io.github.tx2z.XtoMarkdown.png
    sources:
      - type: dir
        path: ../../
