# Publishing to Flathub

Flathub is the main repository for Flatpak applications on Linux. Publishing here makes your app available to millions of Linux users across all distributions.

## Overview

- **Platform**: Linux (all distributions)
- **Cost**: Free
- **Review time**: 1-2 weeks for initial submission
- **Requirements**: GitHub account, Flatpak manifest, proper metadata

## Before Submission Checklist

Based on [Flathub requirements](https://docs.flathub.org/docs/for-app-authors/requirements):

### Application Requirements
- [x] App is fully functional (not minimal/niche CLI tool)
- [x] App is not a web wrapper, font, firmware, or shell extension
- [x] App does not use end-of-life runtimes or deprecated dependencies (using KDE 6.8)

### Application ID
- [x] Uses reverse-DNS format: `com.github.tx2z.XtoMarkdown`
- [x] ID matches MetaInfo file exactly
- [x] You control the domain/namespace (GitHub account `tx2z`)

### License
- [x] License allows redistribution (GPL-3.0-or-later)
- [x] License correctly specified in MetaInfo (`GPL-3.0-or-later`)
- [x] License file exists (LICENSE with GPL-3.0 text)

### Required Files
- [x] **Manifest** (`.yml` or `.json`) - `com.github.tx2z.XtoMarkdown.yml`
- [x] **MetaInfo** - `com.github.tx2z.XtoMarkdown.metainfo.xml`
- [x] **Desktop file** - `com.github.tx2z.XtoMarkdown.desktop`
- [x] **Icon** - 2048x2048 PNG (resized during build to 512, 256, 128, 64, 48)

### MetaInfo Requirements
- [x] Valid XML that passes `appstreamcli validate`
- [x] Contains `<id>`, `<name>`, `<summary>`, `<description>`
- [x] Contains `<metadata_license>` (CC0-1.0)
- [x] Contains `<project_license>` (GPL-3.0-or-later)
- [x] Contains `<launchable type="desktop-id">`
- [x] Contains screenshots with hosted image URLs (5 screenshots added)
- [x] Contains `<url type="homepage">`
- [x] Contains `<developer>` with name (Jesús Pérez)
- [x] Contains `<content_rating type="oars-1.1" />`
- [x] Contains `<releases>` with at least one release (v1.0.0, 2025-11-26)

### Build Requirements
- [x] **No network access during build** - `python-deps.yaml` generated with all offline sources
- [x] Builds from source (not pre-built binaries, except Pandoc which is acceptable)
- [x] Uses only Flathub-hosted runtimes (org.kde.Platform 6.8)
- [x] Minimal permissions requested

### TODO Before Submission
1. ~~**Create screenshots**~~ - Done! 5 screenshots in `screenshots/`
2. ~~**Create GitHub release**~~ - Done! Tag v1.0.0 created
3. ~~**Create Flathub-specific manifest**~~ - Done! `com.github.tx2z.XtoMarkdown.flathub.yml`

**Ready to submit to Flathub!**

## Prerequisites

1. **Install the Flathub Builder**:
   ```bash
   flatpak install flathub org.flatpak.Builder
   ```

2. **Working local build** - Test first:
   ```bash
   ./packaging/linux/build-flatpak.sh
   flatpak install build/flatpak/com.github.tx2z.XtoMarkdown-1.0.0.flatpak
   ```

3. **GitHub account** - Flathub uses GitHub for submissions

## Preparing for Flathub Submission

The local build manifest uses network access for pip packages. For Flathub, you need **offline sources**.

### Step 1: Generate Python Package Sources

Install and use `flatpak-pip-generator`:

```bash
# Install the tool
pip install flatpak-pip-generator

# Generate sources for all Python dependencies
flatpak-pip-generator \
    PySide6==6.7.0 \
    platformdirs \
    pypandoc \
    markitdown \
    hatchling \
    Pillow \
    -o python-deps
```

This creates `python-deps.json` with all package sources and checksums.

### Step 2: Create Flathub Manifest

Create a new manifest for Flathub submission (different from local build):

```yaml
# com.github.tx2z.XtoMarkdown.yml (for Flathub)
app-id: com.github.tx2z.XtoMarkdown
runtime: org.kde.Platform
runtime-version: '6.8'
sdk: org.kde.Sdk
command: xtomarkdown

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=home

modules:
  # Pandoc binary
  - name: pandoc
    buildsystem: simple
    build-commands:
      - install -Dm755 bin/pandoc /app/bin/pandoc
    sources:
      - type: archive
        url: https://github.com/jgm/pandoc/releases/download/3.6.4/pandoc-3.6.4-linux-amd64.tar.gz
        sha256: 5def6e1ff535e397becce292ee97767a947306150b9fb1488003b67ac3417c5e

  # Python dependencies (generated by flatpak-pip-generator)
  - python-deps.json

  # XtoMarkdown application
  - name: xtomarkdown
    buildsystem: simple
    build-commands:
      - pip3 install --no-build-isolation --no-deps --prefix=/app .
      - install -Dm644 packaging/linux/com.github.tx2z.XtoMarkdown.desktop /app/share/applications/com.github.tx2z.XtoMarkdown.desktop
      - install -Dm644 packaging/linux/com.github.tx2z.XtoMarkdown.metainfo.xml /app/share/metainfo/com.github.tx2z.XtoMarkdown.metainfo.xml
      # Icon installation commands...
    sources:
      - type: archive
        url: https://github.com/tx2z/xtomarkdown/archive/refs/tags/v1.0.0.tar.gz
        sha256: GENERATE_THIS_AFTER_RELEASE
```

### Step 3: Generate Source Archive SHA256

After creating a GitHub release:

```bash
curl -sL https://github.com/tx2z/xtomarkdown/archive/refs/tags/v1.0.0.tar.gz | sha256sum
```

### Step 4: Validate MetaInfo

```bash
# Install appstream tools
sudo apt install appstream-util  # Debian/Ubuntu

# Validate the metainfo file
appstreamcli validate packaging/linux/com.github.tx2z.XtoMarkdown.metainfo.xml
```

### Step 5: Test Offline Build

```bash
flatpak run org.flatpak.Builder --force-clean --sandbox --user --install \
    --mirror-screenshots-url=https://dl.flathub.org/media/ \
    build-dir com.github.tx2z.XtoMarkdown.yml
```

### Step 6: Run Flathub Linter

```bash
# Install linter
flatpak install flathub org.flathub.flatpak-external-data-checker

# Run linter on manifest
flatpak run --command=flatpak-builder-lint org.flatpak.Builder manifest com.github.tx2z.XtoMarkdown.yml

# Run linter on built repo
flatpak run --command=flatpak-builder-lint org.flatpak.Builder repo repo
```

## Submission Process

### Step 1: Create GitHub Release

1. Tag your release:
   ```bash
   git tag -a v1.0.0 -m "Release 1.0.0"
   git push origin v1.0.0
   ```

2. Create release on GitHub with:
   - Release notes
   - Source archive is auto-generated

3. Add screenshots to your repo at `screenshots/main-window.png`

### Step 2: Submit to Flathub

1. Go to https://github.com/flathub/flathub
2. Click "Fork"
3. Clone your fork:
   ```bash
   git clone https://github.com/YOUR_USERNAME/flathub.git
   cd flathub
   git checkout -b add-xtomarkdown
   ```

4. Add your manifest file: `com.github.tx2z.XtoMarkdown.yml`

5. Commit and push:
   ```bash
   git add com.github.tx2z.XtoMarkdown.yml python-deps.json
   git commit -m "Add com.github.tx2z.XtoMarkdown"
   git push origin add-xtomarkdown
   ```

6. Create Pull Request at https://github.com/flathub/flathub

### Step 3: Fill PR Template

Your PR should include:
- App description
- Link to source repository
- Confirmation you have rights to submit
- Any special notes for reviewers

### Step 4: Review Process

1. **Automated checks** - Flathub bot tests your manifest
2. **Manual review** - Maintainers check:
   - Proper metadata
   - No unnecessary bundled libraries
   - Security concerns
   - Quality standards
3. **Address feedback** - Make requested changes
4. **Approval** - App gets its own repo

## After Acceptance

### Your App Repository

Once accepted, Flathub creates: `https://github.com/flathub/com.github.tx2z.XtoMarkdown`

You'll have push access to update it.

### Releasing Updates

1. Clone your app's Flathub repo:
   ```bash
   git clone git@github.com:flathub/com.github.tx2z.XtoMarkdown.git
   ```

2. Update for new version:
   - Create new GitHub release with tag
   - Update source URL and SHA256
   - Update version in metainfo.xml releases
   - Regenerate python-deps.json if deps changed

3. Push changes:
   ```bash
   git commit -am "Update to version X.Y.Z"
   git push
   ```

4. Flathub builds and publishes automatically (usually within hours)

## Screenshots

Screenshots are required and must be:
- Hosted at a stable URL (GitHub raw works)
- PNG format recommended
- 16:9 aspect ratio preferred
- Show actual app functionality
- Minimum 620x310 pixels

Add to your repo:
```
screenshots/
  main-window.png
  conversion-complete.png
```

Reference in metainfo.xml:
```xml
<screenshots>
  <screenshot type="default">
    <caption>Main window with drag-and-drop zone</caption>
    <image>https://raw.githubusercontent.com/tx2z/xtomarkdown/main/screenshots/main-window.png</image>
  </screenshot>
</screenshots>
```

## Verification (Optional)

To get a verified checkmark on Flathub:

For `com.github.tx2z.*` apps, you must own the GitHub account `tx2z` - this is verified automatically.

For custom domains, add a file to your website:
```
https://yourdomain.com/.well-known/org.flathub.VerifiedApps.txt
```

Content:
```
com.yourdomain.AppName
```

## Troubleshooting

### Build Fails on Flathub
- Check build logs in the PR
- Ensure all sources have valid URLs and checksums
- Verify no network access needed during build

### Linter Errors
- Run linter locally first
- Common issues: missing metadata, wrong permissions
- Some warnings can be ignored with reviewer approval

### MetaInfo Validation Fails
```bash
appstreamcli validate --pedantic packaging/linux/com.github.tx2z.XtoMarkdown.metainfo.xml
```

## Key Differences: Local vs Flathub Build

| Aspect | Local Build | Flathub Submission |
|--------|-------------|-------------------|
| Network | Allowed (pip install) | **Not allowed** |
| Sources | Can use pip directly | Must use flatpak-pip-generator |
| App source | Local directory | GitHub release archive |
| Testing | Quick iteration | Must pass linter |

## Resources

- Flathub documentation: https://docs.flathub.org/
- Requirements: https://docs.flathub.org/docs/for-app-authors/requirements
- Submission guide: https://docs.flathub.org/docs/for-app-authors/submission
- Flatpak manifest format: https://docs.flatpak.org/en/latest/manifests.html
- AppStream metadata: https://www.freedesktop.org/software/appstream/docs/
- flatpak-pip-generator: https://github.com/flatpak/flatpak-builder-tools/tree/master/pip
